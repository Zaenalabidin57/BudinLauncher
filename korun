#!/bin/bash

# korun - Kotlin Android Development Script
# A utility script for building and installing Android apps

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"

# Function to print colored output
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to check if ADB is available
check_adb() {
    if ! command -v adb &> /dev/null; then
        print_error "ADB is not found in PATH. Please install Android SDK platform-tools."
        exit 1
    fi
}

# Function to check if device is connected
check_device() {
    local devices=$(adb devices | grep -v "List of devices" | grep "device$" | wc -l)
    if [ "$devices" -eq 0 ]; then
        print_error "No Android device connected. Please connect a device and enable USB debugging."
        exit 1
    elif [ "$devices" -gt 1 ]; then
        print_warning "Multiple devices connected. Using first device."
    fi
}

# Function to get device ID
get_device_id() {
    adb devices | grep -v "List of devices" | grep "device$" | head -n1 | awk '{print $1}'
}

# Function to show help
show_help() {
    cat << EOF
korun - Kotlin Android Development Script

USAGE:
    korun [COMMAND] [OPTIONS]

COMMANDS:
    build               Build the project using gradlew
    clean               Clean the project using gradlew
    install             Build and install APK to connected device
    run                 Build, install and launch the app
    uninstall           Uninstall the app from connected device
    logcat              Show logcat output for the app
    devices             List connected ADB devices
    shell               Open ADB shell to connected device
    push <local> <remote>   Push file to device
    pull <remote> [local]   Pull file from device
    restart-activity    Restart the app activity
    clear-data          Clear app data on device
    screenshot          Take screenshot and save to current directory
    screenrecord [file] Record screen (default: screenrecord.mp4)
    help                Show this help message

EXAMPLES:
    korun build                    # Build the project
    korun install                  # Build and install APK
    korun run                      # Build, install and launch app
    korun logcat                   # Show app logs
    korun screenshot               # Take screenshot
    korun screenrecord demo.mp4    # Record screen to demo.mp4

EOF
}

# Function to get app package name from build.gradle
get_package_name() {
    local build_file="$PROJECT_ROOT/app/build.gradle"
    if [ -f "$build_file" ]; then
        grep "namespace" "$build_file" | sed "s/.*namespace '//" | sed "s/'//g" | sed 's/"//g'
    else
        print_error "build.gradle not found at $build_file"
        exit 1
    fi
}

# Function to build project
build_project() {
    print_info "Building project..."
    cd "$PROJECT_ROOT"
    ./gradlew assembleDebug
    print_success "Build completed successfully"
}

# Function to clean project
clean_project() {
    print_info "Cleaning project..."
    cd "$PROJECT_ROOT"
    ./gradlew clean
    print_success "Clean completed successfully"
}

# Function to install APK
install_apk() {
    check_adb
    check_device
    
    local device_id=$(get_device_id)
    print_info "Installing APK to device: $device_id"
    
    # Find the APK file
    local apk_file=$(find "$PROJECT_ROOT/app/build/outputs/apk/debug" -name "*.apk" | head -n1)
    
    if [ -z "$apk_file" ]; then
        print_warning "APK not found. Building project first..."
        build_project
        apk_file=$(find "$PROJECT_ROOT/app/build/outputs/apk/debug" -name "*.apk" | head -n1)
    fi
    
    if [ -n "$apk_file" ]; then
        print_info "Installing: $apk_file"
        adb -s "$device_id" install -r "$apk_file"
        print_success "APK installed successfully"
    else
        print_error "APK file not found after build"
        exit 1
    fi
}

# Function to run app
run_app() {
    install_apk

    local package_name=$(get_package_name)
    local device_id=$(get_device_id)

    print_info "Launching app: $package_name"
    adb -s "$device_id" shell am start -n "$package_name/MainActivity"
    print_success "App launched successfully"

    print_info "Starting logcat monitoring (Press Ctrl+C to stop)..."
    adb -s "$device_id" logcat | grep "$package_name"
}

# Function to uninstall app
uninstall_app() {
    check_adb
    check_device
    
    local package_name=$(get_package_name)
    local device_id=$(get_device_id)
    
    print_info "Uninstalling app: $package_name"
    adb -s "$device_id" uninstall "$package_name"
    print_success "App uninstalled successfully"
}

# Function to show logcat
show_logcat() {
    check_adb
    check_device
    
    local package_name=$(get_package_name)
    local device_id=$(get_device_id)
    
    print_info "Showing logcat for: $package_name"
    adb -s "$device_id" logcat | grep "$package_name"
}

# Function to list devices
list_devices() {
    check_adb
    print_info "Connected ADB devices:"
    adb devices -l
}

# Function to open shell
open_shell() {
    check_adb
    check_device
    
    local device_id=$(get_device_id)
    print_info "Opening ADB shell to device: $device_id"
    adb -s "$device_id" shell
}

# Function to push file
push_file() {
    if [ $# -lt 2 ]; then
        print_error "Usage: korun push <local_path> <remote_path>"
        exit 1
    fi
    
    check_adb
    check_device
    
    local local_path="$1"
    local remote_path="$2"
    local device_id=$(get_device_id)
    
    print_info "Pushing $local_path to $remote_path on device $device_id"
    adb -s "$device_id" push "$local_path" "$remote_path"
    print_success "File pushed successfully"
}

# Function to pull file
pull_file() {
    if [ $# -lt 1 ]; then
        print_error "Usage: korun pull <remote_path> [local_path]"
        exit 1
    fi
    
    check_adb
    check_device
    
    local remote_path="$1"
    local local_path="${2:-$(basename "$remote_path")}"
    local device_id=$(get_device_id)
    
    print_info "Pulling $remote_path from device $device_id to $local_path"
    adb -s "$device_id" pull "$remote_path" "$local_path"
    print_success "File pulled successfully"
}

# Function to restart activity
restart_activity() {
    check_adb
    check_device
    
    local package_name=$(get_package_name)
    local device_id=$(get_device_id)
    
    print_info "Restarting activity for: $package_name"
    adb -s "$device_id" shell am force-stop "$package_name"
    adb -s "$device_id" shell monkey -p "$package_name" -c android.intent.category.LAUNCHER 1
    print_success "Activity restarted successfully"
}

# Function to clear app data
clear_app_data() {
    check_adb
    check_device
    
    local package_name=$(get_package_name)
    local device_id=$(get_device_id)
    
    print_info "Clearing data for: $package_name"
    adb -s "$device_id" shell pm clear "$package_name"
    print_success "App data cleared successfully"
}

# Function to take screenshot
take_screenshot() {
    check_adb
    check_device
    
    local device_id=$(get_device_id)
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    local filename="screenshot_${timestamp}.png"
    local remote_path="/sdcard/$filename"
    
    print_info "Taking screenshot..."
    adb -s "$device_id" shell screencap -p "$remote_path"
    adb -s "$device_id" pull "$remote_path" "$filename"
    adb -s "$device_id" shell rm "$remote_path"
    print_success "Screenshot saved as: $filename"
}

# Function to record screen
record_screen() {
    check_adb
    check_device
    
    local device_id=$(get_device_id)
    local filename="${1:-screenrecord.mp4}"
    local remote_path="/sdcard/$filename"
    
    print_info "Starting screen recording... Press Ctrl+C to stop"
    adb -s "$device_id" shell screenrecord "$remote_path"
    
    if [ $? -eq 0 ]; then
        print_info "Pulling recording..."
        adb -s "$device_id" pull "$remote_path" "$filename"
        adb -s "$device_id" shell rm "$remote_path"
        print_success "Screen recording saved as: $filename"
    else
        print_warning "Screen recording was interrupted"
    fi
}

# Main script logic
case "${1:-help}" in
    "build")
        build_project
        ;;
    "clean")
        clean_project
        ;;
    "install")
        install_apk
        ;;
    "run")
        run_app
        ;;
    "uninstall")
        uninstall_app
        ;;
    "logcat")
        show_logcat
        ;;
    "devices")
        list_devices
        ;;
    "shell")
        open_shell
        ;;
    "push")
        shift
        push_file "$@"
        ;;
    "pull")
        shift
        pull_file "$@"
        ;;
    "restart-activity")
        restart_activity
        ;;
    "clear-data")
        clear_app_data
        ;;
    "screenshot")
        take_screenshot
        ;;
    "screenrecord")
        shift
        record_screen "$@"
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        print_error "Unknown command: $1"
        show_help
        exit 1
        ;;
esac